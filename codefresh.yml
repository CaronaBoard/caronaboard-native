version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: caronaboard/caronaboard-native
    working_directory: ${{main_clone}}
    dockerfile: Dockerfile
  RunningUnitTests:
    title: Running Tests
    image: '${{BuildingDockerImage}}'
    working_directory: IMAGE_WORK_DIR
    environment:
      - NODE_ENV=development
    commands:
      - npm run lint-check
      - npm run test-ci
  UpdateCodeCoverage:
      title: Updating code coverage
      image: '${{BuildingDockerImage}}'
      working_directory: IMAGE_WORK_DIR
      environment:
        - NODE_ENV=development
      commands:
        - npm run update-coverage || true
  DeployToAppetize:
      title: Deploying apps to Appetize
      image: '${{BuildingDockerImage}}'
      working_directory: IMAGE_WORK_DIR
      environment:
        - GIT_BRANCH=${{CF_BRANCH}}
        - REPO_OWNER=${{CF_REPO_OWNER}}
        - REPO_NAME=${{CF_REPO_NAME}}
        - GIT_COMMIT=${{CF_REVISION}}
      commands:
        - bundle install
        - bundle exec fastlane android deployAppetize
